- name: Download Servarr Backups and Upload to Proton Drive, plus ullrservices Docker Compose Files
  hosts: localhost
  gather_facts: true
  vars:
    # List of applications for which backup files are fetched.
    services:
      - radarr 
    remote_path_base: "/opt/nas/apps"
    today: "{{ ansible_date_time.date }}"
    # Local backup folder (inside your Semaphore container)
    local_backup_root: "/tmp/ansible_vm_backups/{{ today }}"
    proton_remote: "proton-remote"
    retention_count: 5

  tasks:
     ###################################################
    # Part 3 – Bazarr Backup (Different Folder Structure)
  ###################################################
    - name: Find latest Bazarr backup file
      shell: "ls -t {{ remote_path_base }}/bazarr/backup/*.zip | head -n 1"
      delegate_to: ullrservarr
      register: bazarr_backup
      retries: 3
      delay: 5
      until: bazarr_backup.rc == 0

    - name: Debug Bazarr backup path
      debug:
        msg: "Bazarr backup: {{ bazarr_backup.stdout }}"

    - name: Ensure local backup folder for Bazarr exists
      file:
        path: "{{ local_backup_root }}/bazarr"
        state: directory
        mode: "0755"

    - name: Fetch Bazarr backup file
      fetch:
        src: "{{ bazarr_backup.stdout }}"
        dest: "{{ local_backup_root }}/bazarr/"
        flat: yes
      delegate_to: ullrservarr
      register: fetch_bazarr
      retries: 3
      delay: 5
      until: fetch_bazarr is success

    - name: Upload Bazarr backup to Proton Drive
      shell: >
        rclone copy
        "{{ local_backup_root }}/bazarr/{{ bazarr_backup.stdout | basename }}"
        "{{ proton_remote }}:backups/{{ today }}/ullrservices/bazarr/"
      environment:
        RCLONE_CONFIG_FILE: "/home/hrolgar/.config/rclone/rclone.conf"
    ###############################################
    # Part 1 – Per-Service Backup Download & Upload
    ###############################################
    - name: Ensure local backup root exists for each service
      file:
        path: "{{ local_backup_root }}/{{ item }}"
        state: directory
        mode: "0755"
      loop: "{{ services }}"

    - name: Find latest backup path on remote host for each service
      shell: "ls -t {{ remote_path_base }}/{{ item }}/Backups/scheduled/*.zip | head -n 1"
      delegate_to: ullrservarr
      register: latest_backups
      retries: 3
      delay: 5
      until: latest_backups.rc == 0
      loop: "{{ services }}"
      loop_control:
        label: "{{ item }}"

    - name: Debug latest backup paths gathered from remote host
      debug:
        msg: "{{ latest_backups.results | map(attribute='stdout') | list }}"

    - name: Set fact mapping each service to its remote backup file path
      set_fact:
        service_backups: "{{ dict(services | zip(latest_backups.results | map(attribute='stdout') | list)) }}"

    - name: Set fact for backup filenames (basename of remote file)
      set_fact:
        service_backup_names: "{{ dict(services | zip(latest_backups.results | map(attribute='stdout') | map('basename') | list)) }}"

    - name: Fetch backup file from remote host for each service
      fetch:
        src: "{{ item.value }}"
        dest: "{{ local_backup_root }}/{{ item.key }}/"
        flat: yes
      delegate_to: ullrservarr
      loop: "{{ service_backups | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      register: fetch_result
      retries: 3
      delay: 5
      until: fetch_result is success

    - name: Upload backup file to Proton Drive for each service (no extra folder)
      shell: >
        rclone copy
        "{{ local_backup_root }}/{{ item }}/{{ service_backup_names[item] }}"
        "{{ proton_remote }}:backups/{{ today }}/ullrservices/{{ item }}"
      loop: "{{ services }}"
      loop_control:
        label: "{{ item }}"
      environment:
        RCLONE_CONFIG_FILE: "/home/hrolgar/.config/rclone/rclone.conf"

    - name: Cleanup old backups in Proton Drive for Servarr backups
      shell: |
        rclone lsjson "{{ proton_remote }}:backups/{{ today }}/ullrservices/" --recursive |
        jq -r '.[] | select(.Path | test(".*\\.zip$")) | .Path' |
        sort -r | tail -n +{{ retention_count + 1 }} |
        xargs -r -I {} rclone delete "{{ proton_remote }}:backups/{}"
      environment:
        RCLONE_CONFIG_FILE: "/home/hrolgar/.config/rclone/rclone.conf"

    ###################################################
    # Part 2 – One-Time Copy & Upload of Compose Files
    ###################################################
    - name: Ensure local backup folder for ullrservices exists
      file:
        path: "{{ local_backup_root }}/ullrservices"
        state: directory
        mode: "0755"

    - name: Copy Docker Compose file (from folder 41) for arr-compose.yml locally
      copy:
        src: "/host_apps/portainer_data/compose/41/docker-compose.yml"
        dest: "{{ local_backup_root }}/ullrservices/arr-compose.yml"
        remote_src: yes

    - name: Upload arr-compose.yml (from folder 41) to Proton Drive
      shell: >
        rclone copy
        "{{ local_backup_root }}/ullrservices/arr-compose.yml"
        "{{ proton_remote }}:backups/{{ today }}/ullrservices/"
      environment:
        RCLONE_CONFIG_FILE: "/home/hrolgar/.config/rclone/rclone.conf"

    - name: Copy Docker Compose file (from folder 40) for arr-extra-compose.yml locally
      copy:
        src: "/host_apps/portainer_data/compose/40/docker-compose.yml"
        dest: "{{ local_backup_root }}/ullrservices/arr-extra-compose.yml"
        remote_src: yes

    - name: Upload arr-extra-compose.yml (from folder 40) to Proton Drive
      shell: >
        rclone copy
        "{{ local_backup_root }}/ullrservices/arr-extra-compose.yml"
        "{{ proton_remote }}:backups/{{ today }}/ullrservices/"
      environment:
        RCLONE_CONFIG_FILE: "/home/hrolgar/.config/rclone/rclone.conf"
        


    #########################
    # Final Cleanup
    #########################
    - name: Remove local backups
      file:
        path: "{{ local_backup_root }}"
        state: absent
      ignore_errors: true
